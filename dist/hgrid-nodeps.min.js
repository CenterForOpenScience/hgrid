/*
 *  HGrid - v0.1.0-pre
 *  A Javascript-based hierarchical grid that can be used to manage and organize files and folders
 */
if("undefined"==typeof jQuery)throw new Error("HGrid requires jQuery to be loaded");!function(a,b,c,d){"use strict";function e(){}function f(){return x++}function g(a){a===d?(this.data={},this.id=u,this.depth=0,this.dataView=new Slick.Data.DataView({inlineFilters:!0})):(this.data=a,this.id=a.id?a.id:f(),this.depth=null,this.dataView=null),this.children=[],this.parentID=null}function h(a,b){var c=b.getItemById(a.parentID);return c?b.getIdxById(c.id)+1:0}function i(a){this.data=a,this.id=a.id?a.id:f(),this.parentID=null,this.depth=null,this.children=[],this.dataView=null}function j(){this.queue=[],this.offset=0}function k(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function l(a){return'<span class="hg-indent" style="width:'+a+'px"></span>'}function m(a,b,c){c=c||t;var d=a.depth*c,e=l(d);return e+b}function n(a,b){var c='<span class="'+r.Html.itemClass+'" data-id="'+a.id+'">',d="</span>";return[c,b,d].join("")}function o(a){var b;b=a.cssClass?r.Html.buttonClass+" "+a.cssClass:r.Html.buttonClass;var c=a.action||"noop",d='<button data-hg-action="'+c+'" class="'+b+'">',e="</button>",f=[d,a.text,e].join("");return f}function p(a){var b=a.map(function(a){var b=o(a);return b}).join("");return b}function q(a){this.name="HGridError",this.message=a||""}function r(b,c){var d=this;if(d.selector=b,d.element=a(b),d.options=a.extend({},A,c),d.grid=null,d.dropzone=null,d.options.searchInput){var e=a(d.options.searchInput);if(!e.length)throw new q("Invalid selector for searchInput.");d.searchInput=e}else d.searchInput=null;"string"==typeof d.options.data?d.getFromServer(d.options.data,function(a){d._initData(a),d.init()}):(d._initData(d.options.data),d.init())}function s(a,b){var c;return b.grid&&b.grid._searchText?(a.depth=0,c=b.searchFilter.call(b.grid,a,b.grid._searchText)):(a.depth=a._node.depth,c=!a._hidden),c}b.HGrid=r,b.HGridError=q;var t=20,u="root",v="item",w="folder",x=0;g.fromObject=function(a,b,c){c=c||{};var d,e,f,h;Array.isArray(a)?(d=new g,e=a):(e=a.children||[],d=new g(a),d.depth=b.depth+1,d.dataView=b.dataView,c.collapse&&(d.data._collapsed=!0));for(var j=0,k=e.length;k>j;j++){var l=e[j];l.kind===v?(f=i.fromObject(l,d,c),d.add(f)):(h=g.fromObject(l,d,c),d.add(h))}return d},g.resetIDCounter=function(){x=0},g._getCurrentID=function(){return x},g.prototype.add=function(a,b){return a.parentID=this.id,a.depth=this.depth+1,a.dataView=this.dataView,this.children.push(a),b&&this.insertIntoDataView(a),this},g.prototype.empty=function(a){if(a){var b=this.getItem();this.dataView.deleteItem(b.id)}for(var c,d=0;c=this.children[d];d++)c.empty(!0),c.children=[];return this.children=[],this},g.prototype.getItem=function(){return this.dataView.getItemById(this.id)},g.prototype.sort=function(a,b){this.children.sort(function(c,d){var e=c.data[a],f=d.data[a],g=b?1:-1,h=(e===f?0:e>f?1:-1)*g;return 0!==h?h:0});for(var c,d=0;c=this.children[d];d++)c.sort(a,b);return this},g.prototype.sortCmp=function(a){this.children.sort(a);for(var b,c=0;b=this.children[c];c++)b.sortCmp(key);return this},g.prototype.insertIntoDataView=function(a){var b,c=a.toData();if(Array.isArray(c))for(var d=0,e=c.length;e>d;d++){var f=c[d];b=h(f,this.dataView),this.dataView.insertItem(b,f)}else b=h(c,this.dataView),this.dataView.insertItem(b,c);return this},g.prototype.ensureDataView=function(a){a||(a=this.dataView),this.dataView=a;for(var b,c=0;b=this.children[c];c++)b.ensureDataView(a);return this},g.prototype.updateDataView=function(a){if(!this.dataView)throw new q("Tree does not have a DataView. updateDataView must be called on a root node.");return a||this.ensureDataView(),this.dataView.beginUpdate(),this.dataView.setItems(this.toData()),this.dataView.endUpdate(),this},g.prototype.toData=function(b){var c=b||[];if(0!==this.depth){var d=a.extend({},{id:this.id,parentID:this.parentID,_node:this,depth:this.depth},this.data);c.push(d)}for(var e=0,f=this.children.length;f>e;e++){var g=this.children[e];g.toData(c)}return c},g.prototype.collapse=function(a,b){var c;this.isRoot()||(c=this.getItem(),a?c._hidden=!0:(c._collapsed=!0,c._hidden=!1));for(var d,e=0;d=this.children[e];e++)d.collapse(!0);return!this.isRoot()&&b&&this.dataView.updateItem(c.id,c),this},g.prototype.bfTraverse=function(a,b){for(var c=new j,d=this;d&&!(b&&d.depth>b);){if(a.call(this,d),d.children.length)for(var e,f=0;e=d.children[f];f++)c.enq(e);d=c.deq()}return this},g.prototype.collapseAt=function(a,b){return 0===a?this.collapse(!1,b):(this.bfTraverse(function(b){b.depth===a&&b instanceof g&&b.collapse(!1,!0)},a),b&&this.dataView.refresh(),this)},g.prototype.expandAt=function(a,b){return 0===a?this.expand(!1,b):(this.bfTraverse(function(b){!b.isRoot()&&b.depth<a&&b.expand(!1,!0)},a),b&&this.dataView.refresh(),this)},g.prototype.isHidden=function(){return this.getItem()._hidden},g.prototype.expand=function(a,b){var c;this.isRoot()||(c=this.getItem(),a||(c._collapsed=!1),c._hidden=!1);for(var d,e=0;d=this.children[e];e++)c._collapsed||d.expand(!0);return!this.isRoot()&&b&&this.dataView.updateItem(c.id,c),this},g.prototype.isRoot=function(){return 0===this.depth},g.prototype.isCollapsed=function(){return Boolean(this.getItem()._collapsed)},i.fromObject=function(a,b,c){c=c||{};var d=new i(a);return b&&(d.depth=b.depth+1,d.parentID=b.id,d.dataView=b.dataView),c.collapse&&(d.data._collapsed=!0),d},i.prototype.getItem=function(){return this.dataView.getItemById(this.id)},i.prototype.collapse=function(){var a=this.getItem();return a._collapsed=a._hidden=!0,this},i.prototype.expand=function(){var a=this.getItem();return a._collapsed=a._hidden=!1,this},i.prototype.toData=function(b){var c=a.extend({},{id:this.id,parentID:this.parentID,_node:this,depth:this.depth},this.data);return b&&b.push(c),c},i.prototype.ensureDataView=function(a){return a||(a=this.dataView),this.dataView=a,this},i.prototype.sort=e,i.prototype.isRoot=function(){return 0===this.depth},i.prototype.empty=function(){var a=this.getItem();return this.dataView.deleteItem(a.id),this},j.prototype.enq=function(a){this.queue.push(a)},j.prototype.deq=function(){if(0===this.queue.length)return d;var a=this.queue[this.offset];return 2*++this.offset>=this.queue.length&&(this.queue=this.queue.slice(this.offset),this.offset=0),a},j.prototype.isEmpty=function(){return 0===this.queue.length};var y={},z=function(a,b){return a?(y[a]=y[a]||new Function("_","return '"+a.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/\{\{\s*(\w+)\s*\}\}/g,"'+(_.$1?(_.$1+'').replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):(_.$1===0?0:''))+'")+"'"),y[a](b)):""};r.Html={expandElem:'<span class="hg-toggle hg-expand"></span>',collapseElem:'<span class="hg-toggle hg-collapse"></span>',folderIcon:'<i class="hg-folder"></i>',fileIcon:'<i class="hg-file"></i>',errorElem:'&nbsp;<span class="error" data-upload-errormessage></span>',buttonClass:"hg-btn",itemClass:"hg-item-content",toggleClass:"hg-toggle"},r.Fmt=r.Format={withIndent:m,asName:n,makeIndentElem:l,sanitized:k,button:o,buttons:p,tpl:z},r.Actions={download:{on:"click",callback:function(a,b){this.options.onClickDownload.call(this,a,b)}},"delete":{on:"click",callback:function(a,b){this.options.onClickDelete.call(this,a,b)}},upload:{on:"click",callback:function(a,b){this.options.onClickUpload.call(this,a,b)}},noop:{on:"click",callback:e}},r.Col=r.Columns={Name:{id:"name",name:"Name",sortkey:"name",cssClass:"hg-cell",folderView:r.Html.folderIcon+" {{name}}",itemView:r.Html.fileIcon+" {{name}}",sortable:!0,indent:t,isName:!0,showExpander:function(a,b){return a.kind===r.FOLDER&&(a._node.children.length&&a.depth||b.lazyLoad)}},ActionButtons:{id:"actions",name:"Actions",cssClass:"hg-cell",width:50,sortable:!1,folderView:function(){var a=[];return this.options.uploads&&a.push({text:"Upload",action:"upload"}),a?p(a):""},itemView:function(){var a=[{text:"Download",action:"download"},{text:"Delete",action:"delete"}];return p(a)}}};var A={data:null,ajaxOptions:{},fetchUrl:null,uploads:!1,columns:[r.Columns.Name],width:600,height:300,highlightClass:"hg-row-highlight",indent:t,slickgridOptions:{},uploadUrl:null,acceptedFiles:null,maxFilesize:256,uploadMethod:"POST",dropzoneOptions:{},onClick:function(){},onClickDownload:function(a,b,c){this.downloadItem(b,c)},onClickDelete:function(a,b,c){this.removeItem(b.id),this.deleteFile(b,c)},onClickUpload:function(a,b){this.uploadToFolder(b)},onExpand:function(){},onCollapse:function(){},onItemAdded:function(){},onDragover:function(){},onDragenter:function(){},onDragleave:function(){},onDrop:function(){},onSort:function(){},uploadAdded:function(){},uploadProcessing:function(){},uploadError:function(b,c){var d,e=a(b.gridElement);return d="string"!=typeof c&&c.error?c.error:c,e.find("[data-upload-errormessage]").each(function(){this.textContent=d}),this},uploadProgress:function(b,c){var d=a(b.gridElement);d.width(c+"%")},uploadSuccess:function(){},uploadComplete:function(){},uploadAccept:function(a,b,c){return c()},downloadUrl:function(){},deleteUrl:function(){},deleteMethod:function(){},listeners:[],init:function(){},searchInput:null,searchFilter:function(a,b){return-1!==a.name.toLowerCase().indexOf(b)},canUpload:function(){return!0},uploadDenied:function(){}};r._defaults=A,r.Tree=g,r.Leaf=i,r.Queue=j,r.DEFAULT_INDENT=t,r.ROOT_ID=u,r.FOLDER=w,r.ITEM=v,q.prototype=new Error,r.prototype.collapseAll=function(){this.tree.collapseAt(1,!0)},r.prototype.emptyFolder=function(a){return a="object"==typeof a?a:this.getByID(a),a._node.empty(),this.getDataView().updateItem(a.id,a),this},r.prototype.getFromServer=function(b,c){var d=this,e=a.extend({},{url:b,contentType:"application/json",dataType:"json",success:function(a){c&&c.call(d,a)},error:function(a,b,e){c&&c.call(d,null,e,b)}},d.options.ajaxOptions);return a.ajax(e)},r.prototype._initData=function(a){var b=this;return a?(b.tree=g.fromObject(Array.isArray(a)?a:a.data),b.tree.updateDataView()):b.tree=new g,b},r.prototype.init=function(){if(this.setHeight(this.options.height).setWidth(this.options.width)._initSlickGrid()._initDataView(),this.options.uploads){if("undefined"==typeof Dropzone)throw new q("uploads=true requires DropZone to be loaded");this._initDropzone()}return this._initListeners(),this.isLazy()&&this.collapseAll(),this.options.init.call(this),this},r.prototype.setHeight=function(a){return"auto"===a?this.options.slickgridOptions.autoHeight=!0:this.element.css("height",a),this},r.prototype.setWidth=function(a){return this.element.css("width",a),this},r.prototype.makeFormatter=function(a){var b,c,d=this,e=a.folderView,f=a.itemView,g=a.showExpander,h="number"==typeof a.indent?a.indent:t,i=function(i,j,k,l,o){var p={colDef:l,row:i,cell:j,indent:a.indent,lazyLoad:d.isLazy()};if(b=o.kind===w?e:f,c="function"==typeof b?b.call(d,o,p):r.Format.tpl(b,o),a.isName&&(c=n(o,c)),g){var q;q="function"==typeof g&&g(o,p)?o._collapsed?r.Html.expandElem:r.Html.collapseElem:"<span></span>",c=[q,c].join("")}return a.indent&&(c=m(o,c,h)),c};return i},r.prototype._makeSlickgridColumns=function(a){var b=this,c=a.map(function(a){return"formatter"in a||(a.formatter=b.makeFormatter.call(b,a)),"text"in a&&(a.name=a.text),a});return c};var B={editable:!1,asyncEditorLoading:!1,enableCellNavigation:!1,enableColumnReorder:!1,forceFitColumns:!0,fullWidthRows:!0};r.prototype._initSlickGrid=function(){var b=this,c=b._makeSlickgridColumns(b.options.columns),d=a.extend({},B,b.options.slickgridOptions);return b.grid=new Slick.Grid(b.element.selector,b.tree.dataView,c,d),b},r.prototype.removeHighlight=function(){return this.element.find("."+this.options.highlightClass).removeClass(this.options.highlightClass),this},r.prototype.getRowElement=function(a){return"object"==typeof a&&(a=a.id),this.grid.getCellNode(this.getDataView().getRowById(a),0).parentNode},r.prototype.addHighlight=function(b){this.removeHighlight();var c;return c=a(b&&b.kind===w?this.getRowElement(b.id):this.getRowElement(b.parentID)),c&&c.addClass(this.options.highlightClass),this},r.prototype.slickEvents={onClick:function(a,b){var c=this.getDataView().getItem(b.row);return this.canToggle(a.target)&&this.toggleCollapse(c,a),this.options.onClick.call(this,a,c),this},onCellChange:function(a,b){return this.getDataView().updateItem(b.item.id,b.item),this},onMouseLeave:function(){this.removeHighlight()},onSort:function(a,b){var c=b.sortCol,d=c.field||c.sortkey;if(!d)throw new q("Sortable column does not define a `sortkey` to sort on.");this.tree.sort(d,b.sortAsc),this.tree.updateDataView(!0),this.options.onSort.call(this,a,c,b)}},r.prototype.getItemFromEvent=function(a){var b=this.grid.getCellFromEvent(a);return b?this.getDataView().getItem(b.row):null},r.prototype.uploadToFolder=function(a){this.currentTarget=a,this.setUploadTarget(a),this.dropzone.hiddenFileInput.click()},r.prototype.downloadItem=function(a){var c;return c="function"==typeof this.options.downloadUrl?this.options.downloadUrl(a):this.options.downloadUrl,c&&(b.location=c),this},r.prototype.deleteFile=function(b,c){var d,e;d="function"==typeof this.options.deleteUrl?this.options.deleteUrl(b):this.options.deleteUrl,e="function"==typeof this.options.deleteMethod?this.options.deleteMethod(b):this.options.deleteMethod;var f=a.extend({},{url:d,type:e},c),g=null;return d&&(g=a.ajax(f)),g},r.prototype.currentTarget=null,r.prototype.setUploadTarget=function(b){function c(a){return"function"==typeof a?a.call(d,b):a}var d=this;d.currentTarget&&a.when(c(d.options.uploadUrl),c(d.options.uploadMethod)).done(function(a,c){d.dropzone.options.url=a,d.dropzone.options.method=c,d.options.uploadAccept&&(d.dropzone.options.accept=function(a,c){return d.options.uploadAccept.call(d,a,b,c)})})},r.prototype.canUpload=function(a){return Boolean(a&&this.options.canUpload(a))},r.prototype.denyUpload=function(a){throw this.options.uploadDenied.call(this,a),new q("Upload permission denied.")},r.prototype.validateTarget=function(a){return this.canUpload(a)?a:this.denyUpload(a)},r.prototype.dropzoneEvents={drop:function(a){this.removeHighlight(),this.validateTarget(this.currentTarget),this.setUploadTarget(this.currentTarget),this.options.onDrop.call(this,a,this.currentTarget)},dragleave:function(a){this.removeHighlight();var b=this.getItemFromEvent(a);this.options.onDragleave.call(this,a,b)},dragenter:function(a){var b=this.getItemFromEvent(a);b&&(this.currentTarget=b.kind===w?b:this.getByID(b.parentID)),this.options.onDragenter.call(this,a,b)},dragover:function(a){var b=this.currentTarget,c=this.getItemFromEvent(a);this.canUpload(b)&&b&&this.addHighlight(b),this.options.onDragover.call(this,a,c)},dragend:function(){this.removeHighlight()},addedfile:function(b){var c=this.currentTarget;this.validateTarget(c);var d;if(this.canUpload(c)){d=this.addItem({name:b.name,kind:r.ITEM,parentID:c.id});var e=this.getRowElement(d.id),f=a(e);b.gridItem=d,b.gridElement=e,f.addClass("hg-upload-started")}return this.options.uploadAdded.call(this,b,b.gridItem),d},thumbnail:e,error:function(b,c){var d=a(b.gridElement);return d.addClass("hg-upload-error").removeClass("hg-upload-processing"),this.options.uploadError.call(this,b,c,b.gridItem)},processing:function(b){return a(b.gridElement).addClass("hg-upload-processing"),this.options.uploadProcessing.call(this,b,b.gridItem),this},uploadprogress:function(a,b,c){return this.options.uploadProgress.call(this,a,b,c,a.gridItem)},success:function(b,c){return a(b.gridElement).addClass("hg-upload-success").removeClass("hg-upload-processing"),this.options.uploadSuccess.call(this,b,b.gridItem,c)},complete:function(a){return this.options.uploadComplete.call(this,a,a.gridItem)}},r.prototype._initListeners=function(){var a,b,c=this;for(a in c.slickEvents)b=c.slickEvents[a].bind(c),c.grid[a].subscribe(b);if(this.options.uploads)for(a in c.dropzoneEvents)b=c.dropzoneEvents[a].bind(c),c.dropzone.on(a,b);for(var d,e=function(a){var b=c.getItemFromEvent(a);return a.data.listenerObj.callback(a,b,a.data.grid)},f=0;d=this.options.listeners[f];f++)c.element.on(d.on,d.selector,{listenerObj:d,grid:c},e);this.attachActionListeners(),c.searchInput&&c.searchInput.keyup(function(){c._searchText=this.value,c.getDataView().refresh(),c.grid.invalidate(),c.grid.render()})},r.prototype.attachActionListeners=function(){var b=this;a.extend(r.Actions,b.options.actions);var c=function(a){var c=b.getItemFromEvent(a);a.data.actionObj.callback.call(b,a,c)};for(var d in r.Actions){var e=r.Actions[d];this.element.on(e.on,'[data-hg-action="'+d+'"]',{actionObj:e},c)}return this},r._hgFilter=s,r.prototype._initDataView=function(){var a=this,b=this.getDataView();return b.beginUpdate(),b.setFilterArgs({grid:a,searchFilter:a.options.searchFilter}),b.setFilter(s),b.endUpdate(),b.onRowCountChanged.subscribe(function(){a.grid.updateRowCount(),a.grid.render()}),b.onRowsChanged.subscribe(function(b,c){a.grid.invalidateRows(c.rows),a.grid.render()}),this};var C={addRemoveLinks:!1,previewTemplate:"<div></div>"};r.prototype._initDropzone=function(){var b,c;b="string"==typeof this.options.uploadUrl?this.options.uploadUrl:"/",c="string"==typeof this.options.uploadMethod?this.options.uploadMethod:"POST";var d=a.extend({},{url:b,acceptedFiles:this.options.acceptedFiles?this.options.acceptedFiles.join(","):null,maxFilesize:this.options.maxFilesize,method:c},C,this.options.dropzoneOptions);return this.dropzone=new Dropzone(this.selector,d),this},r.prototype.destroy=function(){this.element.html(""),this.grid.destroy(),this.dropzone&&this.dropzone.destroy()},r.prototype.getData=function(){return this.getDataView().getItems()},r.prototype.getByID=function(a){var b=this.getDataView();return b.getItemById(a)},r.prototype.getDataView=function(){return this.grid.getData()},r.prototype.getRefreshHints=function(a){var b=this.getDataView().getRowById(a.id),c={expand:{isFilterNarrowing:!1,isFilterExpanding:!0,ignoreDiffsBefore:b},collapse:{isFilterNarrowing:!0,isFilterExpanding:!1,ignoreDiffsBefore:b}};return c},r.prototype.isLazy=function(){return Boolean(this.options.fetchUrl)},r.prototype._lazyLoad=function(a){var b=this,c=b.options.fetchUrl(a);return null!==c?b.getFromServer(c,function(d,e){if(e)throw new q('Could not fetch data from url: "'+c+'". Error: '+e);b.addData(d,a.id),a._node._loaded=!0}):!1},r.prototype.expandItem=function(a,b){var c=this;a="object"==typeof a?a:c.getByID(a);var d=c.getNodeByID(a.id);a._node.expand(),c.isLazy()&&!d._loaded&&this._lazyLoad(a);var e=c.getDataView(),f=c.getRefreshHints(a).expand;return e.setRefreshHints(f),c.getDataView().updateItem(a.id,a),c.options.onExpand.call(c,b,a),c},r.prototype.collapseItem=function(a,b){a="object"==typeof a?a:this.getByID(a),a._node.collapse();var c=this.getDataView(),d=this.getRefreshHints(a).collapse;return c.setRefreshHints(d),c.updateItem(a.id,a),this.options.onCollapse.call(this,b,a),this},r.prototype.updateItem=function(a){return this.getDataView().updateItem(a.id,a)},r.prototype.isCollapsed=function(a){return Boolean(a._collapsed)},r.prototype.canToggle=function(b){return a(b).hasClass(r.Html.toggleClass)},r.prototype.addItem=function(a){var b,c;b=a.kind===r.FOLDER?new r.Tree(a):new r.Leaf(a),c=null==a.parentID?this.tree:this.getNodeByID(a.parentID),c.add(b,!0);var d=this.getByID(b.id);return this.options.onItemAdded.call(this,d),d},r.prototype.addItems=function(a){var b=this;return this.batchUpdate(function(){for(var c=0,d=a.length;d>c;c++){var e=a[c];b.addItem(e)}}),this},r.prototype.batchUpdate=function(a){this.getDataView().beginUpdate(),a.call(this),this.getDataView().endUpdate()},r.prototype.addColumn=function(a){var b=this.grid.getColumns();return b.push(a),this.grid.setColumns(b),this},r.prototype.removeItem=function(a){var b=this.getByID(a);return this.getDataView().deleteItem(a),b},r.prototype.getNodeByID=function(a){if(a===r.ROOT_ID||null==a)return this.tree;var b=this.getByID(a);return b._node},r.prototype.toggleCollapse=function(a,b){return a&&(this.isCollapsed(a)?this.expandItem(a,b):this.collapseItem(a,b)),this},r.prototype.addData=function(a,b){var c,d=this,e=this.getNodeByID(b);c=Array.isArray(a)?a:a.data;for(var f,h=0;f=c[h];h++){var j;if(f.kind===r.FOLDER){var k={collapse:d.isLazy()};j=g.fromObject(f,e,k)}else j=i.fromObject(f,e);e.add(j,!0)}return this},a.fn.hgrid=function(a){this.each(function(){if(!this.id)throw new q("Element must have an ID if initializing HGrid with jQuery");var b="#"+this.id;return new r(b,a)})}}(jQuery,window,document);