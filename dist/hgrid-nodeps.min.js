/*
 *  HGrid - v0.1.0-pre
 *  A Javascript-based hierarchical grid that can be used to manage and organize files and folders
 */
if("undefined"==typeof jQuery)throw new Error("HGrid requires jQuery to be loaded");!function(a,b,c,d){"use strict";function e(a){this.name="HGridError",this.message=a||""}function f(){}function g(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function h(a){return'<span class="hg-indent" style="width:'+a+'px"></span>'}function i(a,b,c){c=c||v;var d=a.depth*c,e=h(d);return e+b}function j(a,b){var c='<div class="hg-item-content" data-id="'+a.id+'">',d="</div>";return[c,b,d].join("")}function k(a){var b;b=a.cssClass?u+" "+a.cssClass:u;var c=a.action||"noop",d='<button data-hg-action="'+c+'" class="'+b+'">',e="</button>",f=[d,a.text,e].join("");return f}function l(a){var b=a.map(function(a){var b=k(a);return b}).join("");return b}function m(a,b){b=b||{};var c=[s.Html.fileIcon,g(a.name),s.Html.errorElem].join("");return j(a,i(a,c,b.indent))}function n(a,b){b=b||{};var c,d=g(a.name);c=a._node.children.length>0?a._collapsed?s.Html.expandElem:s.Html.collapseElem:"<span></span>";var e=[c,s.Html.folderIcon,d,s.Html.errorElem].join(" ");return j(a,i(a,e,b.indent))}function o(){return C++}function p(a){return a===d?(this.id=w,this.depth=0,this.dataView=new Slick.Data.DataView({inlineFilters:!0})):(this.data=a,this.id=a.id?a.id:o(),this.depth=null,this.dataView=null),this.children=[],this.parentID=null,this}function q(a,b){var c=b.getItemById(a.parentID);return c?b.getIdxById(c.id)+1:0}function r(a){return this.data=a,this.id=a.id?a.id:o(),this.parentID=null,this.depth=null,this.children=[],this.dataView=null,this}function s(b,c){if(this.selector=b,this.element=a(b),this.options=a.extend({},B,c),this.options.data&&this.options.ajaxSource)throw new e('Cannot specify both "data" and "ajaxSource"');this._defaults=B,this.options.data?(this.tree=p.fromObject(Array.isArray(this.options.data)?this.options.data:this.options.data.data),this.tree.updateDataView()):this.tree=new p,this.grid=null,this.dropzone=null,this.buttons={file:[],folder:[]},this.init()}function t(a){return!a._hidden}b.HGrid=s,b.HGridError=e;var u="hg-btn",v=15,w="root",x="item",y="folder";e.prototype=new Error;var z={},A=function(a,b){return a?(z[a]=z[a]||new Function("_","return '"+a.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/\{\{\s*(\w+)\s*\}\}/g,"'+(_.$1?(_.$1+'').replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):(_.$1===0?0:''))+'")+"'"),z[a](b)):""};s.Html={expandElem:'<span class="hg-toggle hg-expand"></span>',collapseElem:'<span class="hg-toggle hg-collapse"></span>',folderIcon:' <i class="hg-folder"></i>',fileIcon:'<i class="hg-file"></i>',errorElem:'&nbsp;<span class="error" data-upload-errormessage></span>'},s.Fmt=s.Format={withIndent:i,asItem:j,makeIndentElem:h,sanitized:g,button:k,buttons:l,tpl:A},s.Actions={download:{on:"click",callback:function(a,b){this.options.onClickDownload.call(this,a,b)}},"delete":{on:"click",callback:function(a,b){this.options.onClickDelete.call(this,a,b)}},upload:{on:"click",callback:function(a,b){this.options.onClickUpload.call(this,a,b)}},noop:{on:"click",callback:f}},s.Col=s.Columns={defaultFolderView:n,defaultItemView:m,Name:{id:"name",name:"Name",sortkey:"name",cssClass:"hg-cell",folderView:n,itemView:m,sortable:!0},ActionButtons:{id:"actions",name:"Actions",cssClass:"hg-cell",width:50,sortable:!1,folderView:function(){var a=[];return this.options.uploads&&a.push({text:"Upload",action:"upload"}),a?l(a):""},itemView:function(){var a=[{text:"Download",action:"download"},{text:"Delete",action:"delete"}];return l(a)}}};var B={data:null,uploads:!1,columns:[s.Columns.Name],width:600,height:300,highlightClass:"hg-row-highlight",indent:v,slickgridOptions:{},uploadUrl:null,acceptedFiles:null,maxFilesize:256,uploadMethod:"POST",dropzoneOptions:{},onClick:function(){},onClickDownload:function(a,b,c){this.downloadItem(b,c)},onClickDelete:function(a,b,c){this.removeItem(b.id),this.deleteFile(b,c)},onClickUpload:function(a,b){this.uploadToFolder(b)},onItemAdded:function(){},onDragover:function(){},onDragenter:function(){},onDrop:function(){},onSort:function(){},uploadAdded:function(){},uploadProcessing:function(){},uploadError:function(b,c){var d,e=a(b.gridElement);return d="string"!=typeof c&&c.error?c.error:c,e.find("[data-upload-errormessage]").each(function(){this.textContent=d}),this},uploadProgress:function(b,c){var d=a(b.gridElement);d.width(c+"%")},uploadSuccess:function(){},uploadComplete:function(){},uploadAccept:function(a,b,c){return c()},downloadUrl:function(){},deleteUrl:function(){},deleteMethod:function(){},listeners:[],init:function(){}},C=0;p.fromObject=function(a,b){var c,d,e,f;Array.isArray(a)?(c=new p,d=a):(d=a.children||[],c=new p(a),c.depth=b.depth+1);for(var g=0,h=d.length;h>g;g++){var i=d[g];i.kind===x?(e=r.fromObject(i),c.add(e)):(f=p.fromObject(i,c),c.add(f))}return c},p.resetIDCounter=function(){C=0},p._getCurrentID=function(){return C},p.prototype.add=function(a,b){return a.parentID=this.id,a.depth=this.depth+1,a.dataView=this.dataView,this.children.push(a),b&&this.insertIntoDataView(a),this},p.prototype.getItem=function(){return this.dataView.getItemById(this.id)},p.prototype.sort=function(a,b){this.children.sort(function(c,d){var e=c.data[a],f=d.data[a],g=b?1:-1,h=(e===f?0:e>f?1:-1)*g;return 0!==h?h:0});for(var c,d=0;c=this.children[d];d++)c.sort(a,b)},p.prototype.sortCmp=function(a){this.children.sort(a);for(var b,c=0;b=this.children[c];c++)b.sortCmp(key)},p.prototype.insertIntoDataView=function(a){var b,c=a.toData();if(Array.isArray(c))for(var d=0,e=c.length;e>d;d++){var f=c[d];b=q(f,this.dataView),this.dataView.insertItem(b,f)}else b=q(c,this.dataView),this.dataView.insertItem(b,c)},p.prototype.ensureDataView=function(a){a||(a=this.dataView),this.dataView=a;for(var b,c=0;b=this.children[c];c++)b.ensureDataView(a);return this},p.prototype.updateDataView=function(a){if(!this.dataView)throw new e("Tree does not have a DataView. updateDataView must be called on a root node.");return a||this.ensureDataView(),this.dataView.beginUpdate(),this.dataView.setItems(this.toData()),this.dataView.endUpdate(),this},p.prototype.toData=function(b){var c=b||[];if(0!==this.depth){var d=a.extend({},{id:this.id,parentID:this.parentID,_node:this,depth:this.depth},this.data);c.push(d)}for(var e=0,f=this.children.length;f>e;e++){var g=this.children[e];g.toData(c)}return c},p.prototype.collapse=function(a){var b=this.getItem();a?b._hidden=!0:(b._collapsed=!0,b._hidden=!1);for(var c,d=0;c=this.children[d];d++)c.collapse(!0);return this},p.prototype.expand=function(a){var b=this.getItem();a||(b._collapsed=!1),b._hidden=!1;for(var c,d=0;c=this.children[d];d++)b._collapsed||c.expand(!0);return this},p.prototype.isCollapsed=function(){return this.getItem()._collapsed},r.fromObject=function(a){var b=new r(a);return b},r.prototype.getItem=function(){return this.dataView.getItemById(this.id)},r.prototype.collapse=function(){var a=this.getItem();return a._collapsed=a._hidden=!0,this},r.prototype.expand=function(){var a=this.getItem();return a._collapsed=a._hidden=!1,this},r.prototype.toData=function(b){var c=a.extend({},{id:this.id,parentID:this.parentID,_node:this,depth:this.depth},this.data);return b&&b.push(c),c},r.prototype.ensureDataView=function(a){return a||(a=this.dataView),this.dataView=a,this},r.prototype.sort=function(){},s.Tree=p,s.Leaf=r,s.ROOT_ID=w,s.FOLDER=y,s.ITEM=x,s.prototype.init=function(){if(this.setHeight(this.options.height).setWidth(this.options.width)._initSlickGrid()._initDataView(),this.options.uploads){if("undefined"==typeof Dropzone)throw new e("uploads=true requires DropZone to be loaded");this._initDropzone()}return this._initListeners(),this.options.init.call(this),this},s.prototype.setHeight=function(a){return"auto"===a?this.options.slickgridOptions.autoHeight=!0:this.element.css("height",a),this},s.prototype.setWidth=function(a){return this.element.css("width",a),this},s.prototype.makeFormatter=function(a,b,c){var d,e=this,f=function(f,g,h,i,j){var k={colDef:i,row:f,cell:g,indent:c.indent};return d=j.kind===y?a:b,"function"==typeof d?d.call(e,j,k):s.Format.tpl(d,j)};return f},s.prototype._makeSlickgridColumns=function(a){var b=this,c=a.map(function(a){return"formatter"in a||(a.formatter=b.makeFormatter.call(b,a.folderView,a.itemView,{indent:b.options.indent})),"text"in a&&(a.name=a.text),a});return c};var D={editable:!1,asyncEditorLoading:!1,enableCellNavigation:!1,enableColumnReorder:!1,forceFitColumns:!0,fullWidthRows:!0};s.prototype._initSlickGrid=function(){var b=this,c=b._makeSlickgridColumns(b.options.columns),d=a.extend({},D,b.options.slickgridOptions);return b.grid=new Slick.Grid(b.element.selector,b.tree.dataView,c,d),b},s.prototype.removeHighlight=function(){return this.element.find("."+this.options.highlightClass).removeClass(this.options.highlightClass),this},s.prototype.getRowElement=function(a){return"object"==typeof a&&(a=a.id),this.grid.getCellNode(this.getDataView().getRowById(a),0).parentNode},s.prototype.addHighlight=function(b){this.removeHighlight();var c;return c=a(b&&b.kind===y?this.getRowElement(b.id):this.getRowElement(b.parentID)),c&&c.addClass(this.options.highlightClass),this},s.prototype.slickEvents={onClick:function(a,b){var c=this.getDataView().getItem(b.row);return this.canToggle(a.target)&&this.toggleCollapse(c),this.options.onClick.call(this,a,c),this},onCellChange:function(a,b){return this.getDataView().updateItem(b.item.id,b.item),this},onMouseLeave:function(){this.removeHighlight()},onSort:function(a,b){var c=b.sortCol,d=c.field||c.sortkey;if(!d)throw new e("Sortable column does not define a `sortkey` to sort on.");this.tree.sort(d,b.sortAsc),this.tree.updateDataView(!0),this.options.onSort.call(this,a,c,b)}},s.prototype.getItemFromEvent=function(a){var b=this.grid.getCellFromEvent(a);return b?this.getDataView().getItem(b.row):null},s.prototype.uploadToFolder=function(a){this.currentTarget=a,this.setUploadTarget(a),this.dropzone.hiddenFileInput.click()},s.prototype.downloadItem=function(a){var c;return c="function"==typeof this.options.downloadUrl?this.options.downloadUrl(a):this.options.downloadUrl,c&&(b.location=c),this},s.prototype.deleteFile=function(b,c){var d,e;d="function"==typeof this.options.deleteUrl?this.options.deleteUrl(b):this.options.deleteUrl,e="function"==typeof this.options.deleteMethod?this.options.deleteMethod(b):this.options.deleteMethod;var f=a.extend({},{url:d,type:e},c),g=null;return d&&(g=a.ajax(f)),g},s.prototype.currentTarget=null,s.prototype.setUploadTarget=function(a){var b=this;b.currentTarget&&("function"==typeof this.options.uploadUrl&&(b.dropzone.options.url=b.options.uploadUrl.call(b,a)),"function"==typeof b.options.uploadMethod&&(b.dropzone.options.method=b.options.uploadMethod.call(b,a)),this.options.uploadAccept&&(this.dropzone.options.accept=function(c,d){var e=b.options.uploadAccept.call(b,c,a,d);return e}))},s.prototype.dropzoneEvents={drop:function(a){this.removeHighlight(),this.setUploadTarget(this.currentTarget),this.options.onDrop.call(this,a,this.currentTarget)},dragleave:function(a){this.removeHighlight();var b=this.getItemFromEvent(a);this.options.onDragleave.call(this,a,b)},dragenter:function(a){var b=this.getItemFromEvent(a);b&&(this.currentTarget=b.kind===y?b:this.getByID(b.parentID)),this.options.onDragenter.call(this,a,b)},dragover:function(a){var b=this.currentTarget,c=this.getItemFromEvent(a);b&&(b.allowUploads||"undefined"==typeof b.allowUploads)&&this.addHighlight(b),this.options.onDragover.call(this,a,c)},dragend:function(){this.removeHighlight()},addedfile:function(b){var c=this.currentTarget,d=this.addItem({name:b.name,kind:s.ITEM,parentID:c.id}),e=this.getRowElement(d.id),f=a(e);return b.gridItem=d,b.gridElement=e,f.addClass("hg-upload-started"),this.options.uploadAdded.call(this,b,b.gridItem),d},thumbnail:f,error:function(b,c){var d=a(b.gridElement);return d.addClass("hg-upload-error").removeClass("hg-upload-processing"),this.options.uploadError.call(this,b,c,b.gridItem)},processing:function(b){return a(b.gridElement).addClass("hg-upload-processing"),this.options.uploadProcessing.call(this,b,b.gridItem),this},uploadprogress:function(a,b,c){return this.options.uploadProgress.call(this,a,b,c,a.gridItem)},success:function(b){return a(b.gridElement).addClass("hg-upload-success").removeClass("hg-upload-processing"),this.options.uploadSuccess.call(this,b,b.gridItem)},complete:function(a){return this.options.uploadComplete.call(this,a,a.gridItem)}},s.prototype._initListeners=function(){var a,b,c=this;for(a in c.slickEvents)b=c.slickEvents[a].bind(c),c.grid[a].subscribe(b);if(this.options.uploads)for(a in c.dropzoneEvents)b=c.dropzoneEvents[a].bind(c),c.dropzone.on(a,b);for(var d,e=function(a){var b=c.getItemFromEvent(a);return a.data.listenerObj.callback.call(c,a,b)},f=0;d=this.options.listeners[f];f++)c.element.on(d.on,d.selector,{listenerObj:d},e);this.attachActionListeners()},s.prototype.attachActionListeners=function(){var b=this;a.extend(s.Actions,b.options.actions);var c=function(a){var c=b.getItemFromEvent(a);a.data.actionObj.callback.call(b,a,c)};for(var d in s.Actions){var e=s.Actions[d];this.element.on(e.on,'[data-hg-action="'+d+'"]',{actionObj:e},c)}return this},s._collapseFilter=t,s.prototype._initDataView=function(){var a=this,b=this.getDataView();return b.beginUpdate(),b.setFilter(t),b.endUpdate(),b.onRowCountChanged.subscribe(function(){a.grid.updateRowCount(),a.grid.render()}),b.onRowsChanged.subscribe(function(b,c){a.grid.invalidateRows(c.rows),a.grid.render()}),this};var E={addRemoveLinks:!1,previewTemplate:"<div></div>"};s.prototype._initDropzone=function(){var b,c;b="string"==typeof this.options.uploadUrl?this.options.uploadUrl:"/",c="string"==typeof this.options.uploadMethod?this.options.uploadMethod:"POST";var d=a.extend({},{url:b,acceptedFiles:this.options.acceptedFiles?this.options.acceptedFiles.join(","):null,maxFilesize:this.options.maxFilesize,method:c},E,this.options.dropzoneOptions);return this.dropzone=new Dropzone(this.selector,d),this},s.prototype.destroy=function(){this.element.html(""),this.grid.destroy(),this.dropzone&&this.dropzone.destroy()},s.prototype.getData=function(){return this.getDataView().getItems()},s.prototype.getByID=function(a){var b=this.getDataView();return b.getItemById(a)},s.prototype.getDataView=function(){return this.grid.getData()},s.prototype.expandItem=function(a){a._node.expand();var b=this.getDataView(),c=b.getRowById(a.id);return b.setRefreshHints({isFilterNarrowing:!1,isFilterExpanding:!0,ignoreDiffsBefore:c}),this.getDataView().updateItem(a.id,a),this},s.prototype.collapseItem=function(a){a._node.collapse();var b=this.getDataView(),c=b.getRowById(a.id);return b.setRefreshHints({isFilterNarrowing:!0,isFilterExpanding:!1,ignoreDiffsBefore:c}),b.updateItem(a.id,a),this},s.prototype.isCollapsed=function(a){return a._collapsed},s.prototype.canToggle=function(b){return a(b).hasClass("hg-toggle")},s.prototype.addItem=function(a){var b,c;b=a.kind===s.FOLDER?new s.Tree(a):new s.Leaf(a),c=null==a.parentID?this.tree:this.getNodeByID(a.parentID),c.add(b,!0);var d=this.getByID(b.id);return this.options.onItemAdded.call(this,d),d},s.prototype.addItems=function(a){var b=this;return this.batchUpdate(function(){for(var c=0,d=a.length;d>c;c++){var e=a[c];b.addItem(e)}}),this},s.prototype.batchUpdate=function(a){this.getDataView().beginUpdate(),a.call(this),this.getDataView().endUpdate()},s.prototype.addColumn=function(a){var b=this.grid.getColumns();return b.push(a),this.grid.setColumns(b),this},s.prototype.removeItem=function(a){var b=this.getByID(a);return this.getDataView().deleteItem(a),b},s.prototype.getNodeByID=function(a){if(a===s.ROOT_ID||null==a)return this.tree;var b=this.getByID(a);return b._node},s.prototype.toggleCollapse=function(a){return a&&(this.isCollapsed(a)?this.expandItem(a):this.collapseItem(a)),this}}(jQuery,window,document);