<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <title>OSF FileViewer</title>
    <link rel="stylesheet" href="/static/css/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.16.custom.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/examples.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/file-viewer-core.css" type="text/css" />
</head>
<body>

<div class="options-panel">
    <div id="drop-preview-panel" class="dropzone-previews" style="border-right: 2px solid #11557C; width:388px; min-height:90px; padding: 5px; float:left;">
        <h2>Upload Progress</h2>
    </div>
    <div id="slick-recycle" class="recycle-bin" style="width: 190px; height:90px; padding: 5px; float:right;">Recycle Bin</div>
</div>
<div id="myGrid" class="dropzone dz-Clickable" style="width:600px;height:500px;"></div>



<script src="/static/js/firebugx.js"></script>
<script src="/static/js/jquery-1.7.min.js"></script>
<script src="/static/js/jquery-ui-1.8.16.custom.min.js"></script>
<script src="/static/js/jquery.event.drag-2.2.js"></script>
<script src="/static/js/jquery.event.drop-2.2.js"></script>
<script src="/static/js/dropzone.js"></script>
<script>
    $(document).ready(function() {
        var myDropzone = new Dropzone("#myGrid", {
            url: "/uploader",
            previewsContainer: "#drop-preview-panel"
        } );
        myDropzone.on("success", function(file) {
            // Assign values to the uploads folder, so we can insert the file in the correct spot in the view
            var uploadsFolder = {};
            // Check if the server says that the file exists already
            if (file.xhr.response == "Repeat") {
                console.log("The File already exists!");
                // It is a new file
            } else {
                // Loop through the data and find the Uploads folder
                for (var i = 0; i < data.length; i++) {
                    if ((data[i]['name'] == "uploads") && (data[i]['parent'] == null)){
                        console.log(data[i]['name']);
                        uploadsFolder['id'] = data[i]['id'];
                        uploadsFolder['index'] = i;
                        // Collapse the uploads folder to get rid of glitches in the view render
                        data[i]._collapsed = true;
                        dataView.updateItem(data[i]['id'], data[i]);
                    }
                }
                // Collect the JSON Response from the uploader
                var newSlickInfo = JSON.parse(file.xhr.response);
                // Assign response data to slickItem
                var slickTitle = newSlickInfo[0].name;
                var slickId = data.length;
{#                var slickUnique = data.length;#}
                var slickIndent = 1;
                var slickSize = newSlickInfo[0].size;
                var slickParent = uploadsFolder['id'];
                var slickParentPath = newSlickInfo[0].parent_path;
                var slickPath = newSlickInfo[0].path;
                var slickItem = {
                    name: slickTitle,
                    size: slickSize,
                    parent_path: slickParentPath,
                    parent: slickParent,
                    path: slickPath,
                    id: slickId,
{#                    unique: slickUnique,#}
                    indent: slickIndent
                }
                // Splice in the new row after the uploads folder
                data.splice(uploadsFolder['index'] + 1, 0, slickItem);
                var new_id = uploadsFolder['id']+1;
                console.log(slickItem["path"]);
                for(var x = uploadsFolder['index'] + 1; x<data.length; x++){
                    data[x]['id']=new_id;
                    new_id+=1;
                    if(data[x]['parent_path']){
                        for(var i=0; i<data.length; i++){
                        if(data[i]['path']==data[x]['parent_path']){
                            data[x]['parent']=data[i]['id'];
                        }
                        }
                    }

                }
                console.log(data);
                // Update the dataView
                dataView.beginUpdate();
                dataView.setItems(data);
                dataView.setFilter(myFilter);
                dataView.endUpdate();
            }
            // Re-instantiate the grid
            grid.updateRowCount();
            grid.invalidate();
            grid.render();
        });
    });
</script>
<script src="/static/js/file-viewer-dropzone.js"></script>

<script src="/static/js/slick-grid-dependencies/slick.core.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.formatters.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.editors.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.grid.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.dataview.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.cellrangeselector.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.cellselectionmodel.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.rowselectionmodel.js"></script>
<script src="/static/js/slick-grid-dependencies/slick.rowmovemanager.js"></script>

<script src="/static/js/file-viewer-slickgrid.js"></script>

<script>
    var info_dict = {{ info | safe }}
</script>

</body>
</html>
