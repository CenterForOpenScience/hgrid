var HGrid={defaultOptions:{container:null,url:null,info:null,columns:[{id:"uid",name:"uid",width:40,field:"uid"},{id:"name",name:"Name",field:"name",width:450,cssClass:"cell-title",editor:Slick.Editors.Text,sortable:!0,defaultSortAsc:!0}],editable:!1,enableCellNavigation:!0,asyncEditorLoading:!1,enableColumnReorder:!0,sortAsc:!0,dragDrop:!0},Slick:{},data:null,create:function(options){console.log("Starting create");var _this=this,self=Object.create(_this);self.options=$.extend({},self.defaultOptions,options);for(var urls=["urlAdd","urlMove","urlEdit","urlDelete"],i=0;i<urls.length;i++)self.options[urls[i]]||(self.options[urls[i]]=self.options.url);return self.initialize(),$.extend(this,{nameFunction:new Slick.Event,hGridBeforeMove:new Slick.Event,hGridAfterMove:new Slick.Event,hGridBeforeEdit:new Slick.Event,hGridAfterEdit:new Slick.Event,hGridBeforeDelete:new Slick.Event,hGridAfterDelete:new Slick.Event,hGridBeforeAdd:new Slick.Event,hGridAfterAdd:new Slick.Event}),console.log("Ending create"),self},initialize:function(){var hGridContainer=this.options.container,hGridInfo=this.options.info,hGridColumns=this.options.columns;this.data=this.prep(hGridInfo),this.Slick.dataView=new Slick.Data.DataView({inlineFilters:!0}),this.Slick.dataView.beginUpdate(),this.Slick.dataView.setItems(this.data);var data=this.data,dataView=this.Slick.dataView;this.Slick.dataView.setFilterArgs([data,dataView,this]),this.Slick.dataView.setFilter(this.myFilter),this.Slick.dataView.endUpdate(),this.options.dragDrop&&hGridColumns.unshift({id:"#",name:"",width:40,behavior:"selectAndMove",selectable:!1,resizable:!1,cssClass:"cell-reorder dnd"}),this.Slick.grid=new Slick.Grid(hGridContainer,this.Slick.dataView,hGridColumns,this.options),this.options.columns[this.Slick.grid.getColumnIndex("name")].validator=this.requiredFieldValidator,this.Slick.grid.invalidate(),this.Slick.grid.render(),this.setupListeners()},defaultTaskNameFormatter:function(row,cell,value,columnDef,dataContext){value=value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var spacer="<span style='display:inline-block;height:1px;width:"+15*dataContext.indent+"px'></span>";return"folder"===dataContext.type?dataContext._collapsed?spacer+" <span class='toggle expand'></span><span class='folder'></span>&nbsp;"+value:spacer+" <span class='toggle collapse'></span><span class='folder'></span>&nbsp;"+value:spacer+" <span class='toggle spacer'></span>&nbsp;"+value},requiredFieldValidator:function(value){return null!==value&&void 0!==value&&value.length?{valid:!0,msg:null}:{valid:!1,msg:"This is a required field"}},myFilter:function(item,args){var data=args[0],_this=args[2];if(null!==item.parent)for(var parent=_this.getItemByValue(data,item.parent_uid,"uid");parent;){if(parent._collapsed)return!1;parent=_this.getItemByValue(data,parent.parent_uid,"uid")}return!0},addItem:function(item){var _this=this,parent=_this.getItemByValue(_this.data,item.parent_uid,"uid"),value={item:item,parent:parent},event_status=_this.hGridBeforeAdd.notify(value);if(event_status||"undefined"==typeof event_status){if("null"!==item.parent_uid){var parent_path=parent.path;item.path=[],item.path.concat(parent_path,item.uid),item.sortpath=item.path.join("/")}return _this.data.splice(parent.id+1,0,item),_this.prepJava(_this.data),_this.Slick.dataView.setItems(_this.data),_this.Slick.grid.invalidate(),_this.Slick.grid.setSelectedRows([]),_this.Slick.grid.render(),value.success=!0,_this.hGridAfterAdd.notify(value),!0}return value.success=!1,_this.hGridAfterAdd.notify(value),!1},moveItems:function(src_uid,dest){var _this=this,src_id=[],destination=_this.getItemByValue(_this.data,dest,"uid"),dest_path=destination.path,url=_this.options.url,value={};value.rows=[];for(var i=0;i<src_uid.length;i++){if(-1!=$.inArray(src_uid[i],dest_path))return!1;value.rows.push(src_uid[i])}value.insertBefore=destination.id+1;var event_status=_this.hGridBeforeMove.notify(value);return event_status||"undefined"==typeof event_status?_this.itemMover(value,url,src_id,dest_path)?(console.log("here"),value.success=!0,_this.hGridAfterMove.notify(value),!0):(value.success="There was an error with the grid",_this.hGridAfterMove.notify(value),!1):(value.success=!1,_this.hGridAfterMove.notify(value),!1)},deleteItems:function(rowsToDelete){for(var _this=this,value={items:[]},j=0;j<rowsToDelete.length;j++)value.items.push(_this.getItemByValue(_this.data,rowsToDelete[i],"uid"));var event_status=_this.hGridBeforeDelete.notify(value);if(event_status||"undefined"==typeof event_status){for(var i=0;i<rowsToDelete.length;i++){var rows=[],check=_this.Slick.dataView.getRowById(_this.getItemByValue(_this.data,rowsToDelete[i],"uid").id),j=check;do rows.push(j),j+=1;while(_this.data[j]&&_this.data[j].indent>_this.data[check].indent);_this.data.splice(rows[0],rows.length),_this.Slick.dataView.setItems(_this.data)}return _this.prepJava(_this.data),_this.Slick.dataView.setItems(_this.data),_this.Slick.grid.invalidate(),_this.Slick.grid.setSelectedRows([]),_this.Slick.grid.render(),value.success=!0,_this.hGridAfterDelete.notify(value),!0}return value.success=!1,_this.hGridAfterDelete.notify(value),!1},editItem:function(src_uid,name){var src=this.getItemByValue(this.data,src_uid,"uid"),value={item:src,name:name},event_status=this.hGridBeforeEdit.notify(value);return event_status||"undefined"==typeof event_status?(src.name=name,this.Slick.dataView.updateItem(src.id,src),value.success=!0,this.hGridAfterEdit.notify(value),!0):(value.success=!1,this.hGridAfterEdit.notify(value),!1)},getItemByValue:function(data,searchVal,searchProp){for(var ans,i=0;i<data.length;i++)if(data[i][searchProp]==searchVal)return ans=data[i];return!1},getItemsByValue:function(data,searchVal,searchProp){for(var propArray=[],i=0;i<data.length;i++)data[i][searchProp]==searchVal&&propArray.push(data[i]);return propArray},prep:function(info){for(var checker={},i=0,data_counter=0,output=[],_this=this;info.length>=1;){var d=info[i];"null"==info[i].parent_uid?(d.parent=null,d.indent=0,d.id=data_counter,checker[d.uid]=[d.indent,data_counter],output[data_counter]=d,data_counter++,info.splice(i,1)):info[i].parent_uid in checker?(d.parent=checker[d.parent_uid][1],d.indent=checker[d.parent_uid][0]+1,d.id=data_counter,checker[d.uid]=[d.indent,data_counter],output[data_counter]=d,data_counter++,info.splice(i,1)):i++,i>=info.length&&(i=0),"null"==d.name&&(d.name+=i)}for(var l=0;l<output.length;l++){var path=[];if(path.push(output[l].uid),"null"!=output[l].parent_uid)for(var m=0;l>m;m++)if(output[m].uid==output[l].parent_uid){for(;"null"!=output[m].parent_uid;)path.push(output[m].uid),m=output[m].parent;path.push(output[m].uid);break}path.reverse(),output[l].path=path,output[l].sortpath=path.join("/")}var sortingCol="sortpath";return output.sort(function(a,b){var x=a[sortingCol],y=b[sortingCol];return x==y?0:_this.options.sortAsc?x>y?1:-1:y>x?1:-1}),this.prepJava(output)},prepJava:function(sortedData){for(var output=[],checker={},indent=0,i=0;i<sortedData.length;i++){var d={},path=[];if(d.parent_uid=sortedData[i].parent_uid,path.push(sortedData[i].uid),"null"!=sortedData[i].parent_uid){for(var j=0;j<sortedData.length;j++)if(sortedData[j].uid==d.parent_uid&&!d.parent){d.parent=j;break}sortedData[i].parent_uid in checker?indent=checker[sortedData[i].parent_uid]:indent++,checker[sortedData[i].parent_uid]=indent}else indent=0,d.parent=null;sortedData[i]._collapsed&&(d._collapsed=sortedData[i]._collapsed),d.id=i,d.indent=indent,d=$.extend(!0,sortedData[i],d),output[i]=d}return output},itemMover:function(args,url,src,dest){this.removeDraggerGuide();for(var y=0;y<args.rows.length;y++){var stopRow,rows=[],item=this.getItemByValue(this.data,args.rows[y],"uid"),j=item.id;do rows.push(j),j+=1,stopRow=j;while(this.data[j]&&this.data[j].indent>item.indent);var left,right,extractedRows=[],insertBefore=this.Slick.grid.getDataItem(args.insertBefore).id;left=this.data.slice(0,insertBefore),right=this.data.slice(insertBefore,this.data.length),rows.sort(function(a,b){return a-b});for(var i=0;i<rows.length;i++)extractedRows.push(this.data[rows[i]]);rows.reverse();for(var i=0;i<rows.length;i++){var row=rows[i];insertBefore>row?left.splice(row,1):right.splice(row-insertBefore,1)}var checker={},old_path=extractedRows[0].path;null==dest?(extractedRows[0].path=[extractedRows[0].uid],extractedRows[0].parent_uid="null"):(extractedRows[0].parent_uid=dest[dest.length-1],extractedRows[0].path=dest.slice(),extractedRows[0].path.push(extractedRows[0].uid),extractedRows[0].sortpath=extractedRows[0].path.join("/"));var new_path=extractedRows[0].uid;if(checker[old_path]=new_path,extractedRows.length>1)for(var m=1;m<extractedRows.length;m++){var par=this.getItemByValue(extractedRows,extractedRows[m].parent_uid,"uid").path;extractedRows[m].path=par.slice(),extractedRows[m].path.push(extractedRows[m].uid),extractedRows[m].sortpath=extractedRows[m].path.join("/")}this.data=left.concat(extractedRows.concat(right));for(var selectedRows=[],i=0;i<rows.length;i++)selectedRows.push(left.length+i);var new_data=this.prepJava(this.data);this.data=new_data}return this.Slick.dataView.setItems(this.data),this.Slick.grid.invalidate(),this.Slick.grid.setSelectedRows([]),this.Slick.grid.render(),!0},removeDraggerGuide:function(){var _this=this;$(_this.options.container).find(".dragger-guide").removeClass("dragger-guide"),$(_this.options.container).find(".slick-viewport").removeClass("dragger-guide1")},draggerGuide:function(inserter){var _this=this;_this.removeDraggerGuide();var dragParent=!1;if(null==inserter)$(_this.options.container).find(".slick-viewport").addClass("dragger-guide1");else{if("uploads"!=inserter.uid)if("folder"==inserter.type)dragParent=_this.Slick.grid.getCellNode(_this.Slick.dataView.getRowById(inserter.id),0).parentNode;else try{dragParent=_this.Slick.grid.getCellNode(_this.Slick.dataView.getRowById(inserter.parent),0).parentNode}catch(err){}dragParent&&$(dragParent).addClass("dragger-guide")}},onSort:function(e,args,grid,dataView,data){this.options.sortAsc=!this.options.sortAsc;var sortingCol=args.sortCol.field,sorted=this.sortHierarchy(data,sortingCol,dataView,grid),new_data=this.prepJava(sorted);this.data=new_data,dataView.setItems(new_data),grid.invalidate(),grid.setSelectedRows([]),grid.render()},sortHierarchy:function(data,sortingCol){var _this=this,sorted=data.sort(function(a,b){var x=a[sortingCol],y=b[sortingCol];return x==y?0:_this.options.sortAsc?x>y?1:-1:y>x?1:-1}),hierarchical=[];return this.buildHierarchy(sorted,hierarchical,void 0),hierarchical},buildHierarchy:function(sorted,hierarchical,parent){for(var i=0;i<sorted.length;i++){var parentId,item=sorted[i];parentId=parent?parent.id:void 0,item.parent==parentId&&(hierarchical.push(sorted[i]),this.buildHierarchy(sorted,hierarchical,sorted[i]))}},setupListeners:function(){var _this=this,grid=this.Slick.grid,data=this.data,dataView=this.Slick.dataView,src=[],dest="";grid.setSelectionModel(new Slick.RowSelectionModel);var moveRowsPlugin=new Slick.RowMoveManager({cancelEditOnDrag:!0});moveRowsPlugin.onBeforeMoveRows.subscribe(function(e,args){src=[],dest="";var inserter=null;grid.getDataItem(args.insertBefore-1)&&(inserter=args.insertBefore==args.rows[0]+1?grid.getDataItem(args.insertBefore-2):grid.getDataItem(args.insertBefore-1));try{var insertBefore=grid.getDataItem(args.insertBefore).id}catch(error){if(error.name==TypeError)return!1}null!=inserter?"folder"==inserter.type?dest=inserter.path:(dest=_this.getItemByValue(data,inserter.parent_uid,"uid"),dest=dest.path):dest=null;for(var i=0;i<args.rows.length;i++){src[i]=_this.getItemByValue(_this.data,_this.Slick.dataView.getItem(args.rows[i]).id,"id").path,""==dest&&(dest=null);var index=!0;if(null!=dest?(-1!=dest.indexOf(src[i][src[i].length-1])||"catch"==dest||0==dest.indexOf("uploads"))&&(index=!1):inserter=null,_this.draggerGuide(inserter),args.rows[i]==insertBefore-1||0==index||"uploads"==src[i]||"uploads"==dest)return _this.removeDraggerGuide(),!1}return!0}),moveRowsPlugin.onMoveRows.subscribe(function(e,args){for(var src_id=[],i=0;i<src.length;i++)src_id.push(src[i][src[i].length-1]);var value={};value.rows=[];for(var j=0;j<src_id.length;j++)value.rows.push(src_id[j]);value.insertBefore=args.insertBefore;var event_status=_this.hGridBeforeMove.notify(value);event_status||"undefined"==typeof event_status?(_this.itemMover(value,"/sg_move",src,dest),value.success=!0,_this.hGridAfterMove.notify(value,e)):(_this.removeDraggerGuide(),alert("Move failed"),value.success=!1,_this.hGridAfterMove.notify(value,e))}),grid.registerPlugin(moveRowsPlugin),grid.onCellChange.subscribe(function(e,args){_this.options.editable=!1;var src=args.item;console.log(args),_this.Slick.dataView.updateItem(src.id,src)}),grid.onClick.subscribe(function(e,args){if($(e.target).hasClass("toggle")){var item=dataView.getItem(args.row);if(item){var i=args.row,counter=-1;do counter+=1,i+=1;while(data[i]&&data[i].indent>data[args.row].indent);item._collapsed?(item._collapsed=!1,counter=-counter):item._collapsed=!0,dataView.updateItem(item.id,item)}e.stopImmediatePropagation()}grid.getOptions().editable=!1}),dataView.onRowCountChanged.subscribe(function(){grid.updateRowCount(),grid.render()}),dataView.onRowsChanged.subscribe(function(e,args){grid.invalidateRows(args.rows),grid.render()}),grid.onColumnsReordered.subscribe(function(e,args){grid.invalidate(),_this.options.columns=args.cols,grid.render()}),grid.onSort.subscribe(function(e,args){_this.onSort(e,args,grid,dataView,data)}),grid.onDblClick.subscribe(function(){"uploads"!=data[grid.getActiveCell().row].uid&&grid.getActiveCell().cell==grid.getColumnIndex("name")&&(grid.getOptions().editable=!0)})}};